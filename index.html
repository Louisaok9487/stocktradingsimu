<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Simulator v2.3 (Bug Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100vh; /* Use viewport height */
            overflow: hidden; /* Prevent scrolling */
            font-family: 'Inter', sans-serif;
        }
        .asset-card {
            transition: all 0.2s ease-in-out;
        }
        .asset-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        /* Custom scrollbar for the rare case it's needed on small screens */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col h-screen">

    <header class="text-center py-2 bg-white shadow-md">
        <h1 class="text-2xl font-bold text-gray-900">Stock Market Simulator</h1>
        <p class="text-sm text-gray-600">A 20-Year Backtest of S&P 500, Nasdaq, Gold & Silver (2004-2023)</p>
    </header>

    <main class="flex-grow grid grid-cols-1 lg:grid-cols-4 gap-4 p-4 overflow-hidden">
        <!-- Left Control Panel -->
        <div class="lg:col-span-1 bg-white p-3 rounded-xl shadow-lg flex flex-col space-y-2">
            <div>
                <h2 class="text-lg font-bold mb-1">Your Portfolio</h2>
                <div class="bg-blue-50 p-2 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 text-sm">Net Worth (USD)</span>
                        <span id="net-worth" class="text-lg font-bold text-blue-600">$100,000.00</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-gray-600 text-sm">Cash Balance</span>
                        <span id="cash-balance" class="font-semibold text-sm">$100,000.00</span>
                    </div>
                </div>
            </div>

            <!-- Time Controller -->
            <div>
                <h3 class="text-lg font-semibold mb-1">Time Controller</h3>
                <div class="space-y-2 bg-gray-50 p-2 rounded-lg">
                    <div class="text-center">
                        <span class="text-md font-medium text-indigo-600" id="current-date-display">2004-01</span>
                    </div>
                    <input type="range" id="time-slider" min="0" max="239" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                     <div class="flex justify-between text-xs text-gray-500">
                        <span>2004</span>
                        <span>2014</span>
                        <span>2023</span>
                    </div>
                    <div class="flex justify-center space-x-2">
                        <button id="start-pause-btn" class="btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Start</button>
                        <button id="reset-btn" class="btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Reset</button>
                    </div>
                </div>
            </div>

            <!-- Asset Trading -->
            <div class="flex-grow overflow-y-auto pr-2 min-h-0">
                <h3 class="text-lg font-semibold mb-1">Asset Trading</h3>
                <div id="asset-controls" class="space-y-2">
                    <!-- Asset cards will be dynamically generated by JS -->
                </div>
            </div>
        </div>

        <!-- Right Chart and Log -->
        <div class="lg:col-span-3 bg-white p-4 rounded-xl shadow-lg flex flex-col">
            <div class="flex-grow relative">
                <canvas id="price-chart"></canvas>
            </div>
            <div class="mt-2">
                <h3 class="text-lg font-semibold mb-1">Transaction Log</h3>
                <div id="transaction-log" class="h-24 bg-gray-50 rounded-lg p-2 overflow-y-auto text-xs">
                    <p class="text-gray-500">Click 'Start' or drag the slider to begin your investment journey!</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Data Set (2004-2023, 240 months) ---
        const historicalData = {
            dates: Array.from({length: 240}, (_, i) => {
                const year = 2004 + Math.floor(i / 12);
                const month = (i % 12) + 1;
                return `${year}-${month.toString().padStart(2, '0')}`;
            }),
            assets: {
                sp500: { name: "S&P 500", color: "rgba(59, 130, 246, 1)", yAxisID: 'y', data: [1131,1143,1126,1107,1121,1101,1124,1104,1130,1163,1181,1212,1181,1188,1172,1191,1204,1234,1218,1248,1247,1273,1280,1295,1284,1270,1289,1305,1379,1407,1438,1421,1471,1519,1525,1502,1478,1409,1378,1316,1331,1280,1283,1249,1166,1069,969,908,825,852,903,919,979,948,1033,1028,1099,1109,1136,1115,1049,1089,1108,1145,1188,1226,1286,1308,1314,1320,1325,1284,1258,1247,1292,1254,1312,1316,1345,1366,1379,1360,1335,1406,1410,1430,1409,1498,1512,1598,1634,1640,1613,1656,1633,1692,1756,1782,1828,1848,1872,1859,1938,1973,1960,1983,1931,2032,2067,2020,2060,2107,2080,2063,2102,2051,1920,1986,2050,2092,1918,1940,2048,2065,2097,2173,2183,2150,2128,2168,2139,2275,2297,2364,2363,2388,2412,2460,2478,2472,2519,2575,2648,2823,2713,2641,2677,2705,2747,2818,2803,2897,2910,2785,2510,2596,2704,2785,2804,2926,2980,3014,2926,2968,3038,3130,3257,3295,2954,2585,2912,3108,3218,3298,3380,3500,3363,3714,3826,3935,3811,4180,4168,4319,4395,4529,4605,4663,4567,4631,4327,4497,4175,4132,3966,3825,3901,3679,3872,4076,4137,4193,4280,4378,4450,4582,4567,4515,4625,4740,4846] },
                nasdaq: { name: "Nasdaq", color: "rgba(139, 92, 246, 1)", yAxisID: 'y', data: [2086,2153,2044,1999,2035,1859,1913,1879,1948,2032,2088,2179,2088,2114,2046,2124,2150,2184,2156,2249,2268,2288,2305,2315,2275,2135,2207,2240,2381,2415,2463,2438,2577,2691,2674,2616,2580,2425,2523,2395,2350,2305,2290,2200,1970,1820,1650,1590,1516,1550,1720,1780,1909,1838,2091,2080,2269,2258,2330,2234,2251,2196,2249,2355,2479,2580,2689,2737,2789,2790,2816,2722,2643,2580,2745,2630,2786,2813,2873,2935,2940,2890,2840,3010,3020,3078,3018,3142,3160,3363,3450,3510,3445,3578,3500,3697,3860,4153,4131,4245,4310,4276,4398,4457,4485,4508,4297,4650,4775,4637,4717,4947,4890,4935,4988,4838,4590,4730,4895,4950,4506,4590,4863,4900,4960,5166,5213,5180,5046,5251,5243,5429,5487,5840,5860,5900,6048,6245,6312,6220,6422,6716,6862,7411,7069,6777,6930,7119,7250,7759,7640,7940,7960,7520,6665,6980,7320,7550,7630,7950,8006,8160,7976,8090,8290,8820,9150,9220,8170,7000,8600,10745,10900,11300,12000,12800,11900,13070,13500,14000,13200,14200,13800,14522,14670,15300,15500,15250,14800,15100,14200,14900,13500,13300,11816,11300,11500,10800,11700,12200,12800,13000,13500,13800,14000,14346,14280,14050,14550,14900,15019] },
                gold: { name: "Gold", color: "rgba(245, 158, 11, 1)", yAxisID: 'y1', data: [414,428,425,433,420,396,408,415,422,435,427,440,427,430,432,425,424,435,433,450,470,510,557,590,650,646,655,670,640,652,660,665,680,710,780,830,860,920,910,930,880,890,865,882,905,945,935,970,920,880,940,955,1104,1110,1080,1122,1197,1180,1210,1245,1330,1368,1410,1480,1530,1594,1770,1650,1560,1734,1710,1650,1618,1675,1690,1660,1580,1400,1320,1232,1330,1380,1243,1260,1280,1305,1293,1270,1210,1170,1283,1220,1180,1150,1096,1060,1120,1230,1118,1240,1320,1341,1320,1310,1275,1220,1210,1250,1270,1241,1215,1268,1290,1325,1344,1322,1285,1295,1223,1218,1280,1300,1282,1325,1410,1415,1470,1510,1475,1575,1680,1500,1470,1650,1730,1962,1880,1920,1840,1780,1840,1814,1890,1930,1820,1800,1765,1720,1660,1800,1928,1980,1950,1920,1960,1925,1960,1945,1990,2040,2033] },
                silver: { name: "Silver", color: "rgba(107, 114, 128, 1)", yAxisID: 'y1', data: [6.5,6.8,6.7,6.9,6.9,6.9,7.0,7.1,7.0,7.2,7.1,7.3,7.1,7.2,7.1,7.0,7.0,7.2,7.1,8.0,9.2,10.1,11.5,12.0,12.3,12.5,13.1,12.9,12.8,12.7,13.2,13.5,14.0,14.8,15.1,16.5,17.2,17.6,17.0,17.2,16.0,16.5,11.1,12.0,12.8,13.5,13.2,14.5,13.9,12.5,15.5,18.0,17.4,17.9,17.2,18.5,17.8,18.2,18.8,19.5,26.5,29.9,35.0,38.0,39.1,48.0,35.0,30.0,33.1,32.0,30.0,27.9,31.5,32.0,30.1,28.0,23.0,21.5,19.1,22.0,23.5,19.5,19.8,20.5,21.2,20.6,19.5,17.5,16.0,17.8,16.5,15.8,15.2,14.7,14.1,14.5,15.8,14.1,16.5,18.9,20.3,19.5,19.2,18.5,17.2,17.1,17.5,18.1,16.3,16.1,16.8,16.5,17.0,17.2,16.8,16.2,16.5,15.4,15.0,15.8,16.2,15.4,16.5,16.2,17.2,18.5,17.8,18.2,19.0,17.5,18.0,26.0,28.0,24.3,22.5,23.0,25.1,26.5,27.5,25.6,27.0,28.1,23.1,22.5,20.0,19.5,18.5,20.8,23.7,24.5,24.1,23.5,24.8,23.8,24.1,23.5,24.5,25.2,23.1] }
            }
        };

        // --- Game State ---
        let gameState = {
            cash: 100000,
            portfolio: { sp500: { shares: 0, value: 0 }, nasdaq: { shares: 0, value: 0 }, gold: { shares: 0, value: 0 }, silver: { shares: 0, value: 0 } },
            netWorth: 100000,
            currentTimeIndex: 0,
            isRunning: false,
            gameInterval: null
        };

        // --- DOM Elements ---
        const currentDateDisplay = document.getElementById('current-date-display');
        const netWorthDisplay = document.getElementById('net-worth');
        const cashBalanceDisplay = document.getElementById('cash-balance');
        const assetControlsContainer = document.getElementById('asset-controls');
        const transactionLog = document.getElementById('transaction-log');
        const ctx = document.getElementById('price-chart').getContext('2d');
        const startPauseBtn = document.getElementById('start-pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const timeSlider = document.getElementById('time-slider');
        
        // --- Chart.js Initialization ---
        let priceChart;

        function initializeChart() {
            if (priceChart) priceChart.destroy();
            const datasets = Object.keys(historicalData.assets).map(key => {
                const asset = historicalData.assets[key];
                return {
                    label: asset.name, data: [], borderColor: asset.color,
                    backgroundColor: asset.color.replace('1)', '0.1)'),
                    borderWidth: 2, pointRadius: 0, tension: 0.4, yAxisID: asset.yAxisID
                };
            });
            priceChart = new Chart(ctx, {
                type: 'line', data: { labels: [], datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Index Price (USD)' } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Metal Price (USD/oz)' }, grid: { drawOnChartArea: false } },
                        x: { ticks: { autoSkip: true, maxTicksLimit: 12 } }
                    },
                    plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }
        
        // --- Game Logic ---
        function updateDisplay() {
            const currentIndex = gameState.currentTimeIndex;
            currentDateDisplay.textContent = historicalData.dates[currentIndex];
            timeSlider.value = currentIndex;

            let portfolioValue = 0;
            Object.keys(historicalData.assets).forEach(key => {
                const currentPrice = historicalData.assets[key].data[currentIndex];
                const shares = gameState.portfolio[key].shares;
                gameState.portfolio[key].value = shares * currentPrice;
                portfolioValue += gameState.portfolio[key].value;

                const priceEl = document.getElementById(`${key}-price`);
                const sharesEl = document.getElementById(`${key}-shares`);
                if (priceEl) priceEl.textContent = `$${currentPrice.toLocaleString()}`;
                if (sharesEl) sharesEl.textContent = `${shares.toFixed(3)}`;
            });

            gameState.netWorth = gameState.cash + portfolioValue;
            netWorthDisplay.textContent = `$${gameState.netWorth.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            cashBalanceDisplay.textContent = `$${gameState.cash.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            
            updateChart();
        }

        function updateChart() {
            const currentIndex = gameState.currentTimeIndex;
            priceChart.data.labels = historicalData.dates.slice(0, currentIndex + 1);
            Object.keys(historicalData.assets).forEach((key, i) => {
                priceChart.data.datasets[i].data = historicalData.assets[key].data.slice(0, currentIndex + 1);
            });
            priceChart.update('none');
        }

        function createAssetControls() {
            assetControlsContainer.innerHTML = '';
            Object.keys(historicalData.assets).forEach(key => {
                const asset = historicalData.assets[key];
                const card = document.createElement('div');
                card.className = 'asset-card bg-white border border-gray-200 p-2 rounded-lg';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="text-sm font-bold" style="color: ${asset.color};">${asset.name}</h4>
                        <span id="${key}-price" class="font-semibold text-sm text-gray-700">$0.00</span>
                    </div>
                    <div class="text-xs text-gray-500 mb-2">
                        Shares: <span id="${key}-shares" class="font-medium text-gray-800">0.000</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <input type="number" id="${key}-amount" class="w-full border-gray-300 rounded-md shadow-sm text-xs p-1" placeholder="Amount (USD)">
                        <button onclick="buy('${key}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded-md text-xs">Buy</button>
                        <button onclick="sell('${key}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-md text-xs">Sell</button>
                    </div>
                `;
                assetControlsContainer.appendChild(card);
            });
        }
        
        function logTransaction(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = `[${historicalData.dates[gameState.currentTimeIndex]}] ${message}`;
            
            if (type === 'buy') p.className = 'text-green-600';
            else if (type === 'sell') p.className = 'text-red-600';
            else if (type === 'error') p.className = 'text-yellow-600';
            else p.className = 'text-gray-500';

            const firstLog = transactionLog.querySelector('p');
            if (firstLog && firstLog.textContent.includes('your investment journey')) {
                transactionLog.innerHTML = '';
            }
            transactionLog.prepend(p);
        }

        function buy(assetKey) {
            const amountInput = document.getElementById(`${assetKey}-amount`);
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0) { logTransaction("Please enter a valid amount.", 'error'); return; }
            if (amount > gameState.cash) { logTransaction("Insufficient cash balance.", 'error'); return; }
            
            const currentPrice = historicalData.assets[assetKey].data[gameState.currentTimeIndex];
            const sharesToBuy = amount / currentPrice;
            gameState.cash -= amount;
            gameState.portfolio[assetKey].shares += sharesToBuy;
            logTransaction(`Bought ${amount.toFixed(2)} USD of ${historicalData.assets[assetKey].name}.`, 'buy');
            amountInput.value = '';
            updateDisplay();
        }

        function sell(assetKey) {
            const amountInput = document.getElementById(`${assetKey}-amount`);
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0) { logTransaction("Please enter a valid amount.", 'error'); return; }
            
            const currentPrice = historicalData.assets[assetKey].data[gameState.currentTimeIndex];
            const valueOwned = gameState.portfolio[assetKey].shares * currentPrice;
            if (amount > valueOwned) { logTransaction(`Not enough ${historicalData.assets[assetKey].name} to sell.`, 'error'); return; }
            
            const sharesToSell = amount / currentPrice;
            gameState.portfolio[assetKey].shares -= sharesToSell;
            gameState.cash += amount;
            logTransaction(`Sold ${amount.toFixed(2)} USD of ${historicalData.assets[assetKey].name}.`, 'sell');
            amountInput.value = '';
            updateDisplay();
        }

        function advanceTime() {
            if (gameState.currentTimeIndex < historicalData.dates.length - 1) {
                gameState.currentTimeIndex++;
                updateDisplay();
            } else {
                pauseGame();
                logTransaction("Simulation finished! Check your final results.", "info");
            }
        }
        
        function startGame() {
            if (gameState.isRunning) return;
            if (gameState.currentTimeIndex >= historicalData.dates.length - 1) {
                logTransaction("Simulation has ended. Please reset to start over.", "info");
                return;
            }
            gameState.isRunning = true;
            startPauseBtn.textContent = 'Pause';
            startPauseBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'bg-yellow-500', 'hover:bg-yellow-600');
            startPauseBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            gameState.gameInterval = setInterval(advanceTime, 1000); // 1 second per month
        }

        function pauseGame() {
            if (!gameState.isRunning) return;
            clearInterval(gameState.gameInterval);
            gameState.isRunning = false;
            startPauseBtn.textContent = 'Resume';
            startPauseBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            startPauseBtn.classList.add('bg-green-500', 'hover:bg-green-600');
        }

        function resetGame() {
            pauseGame();
            gameState = {
                cash: 100000, portfolio: { sp500: { shares: 0, value: 0 }, nasdaq: { shares: 0, value: 0 }, gold: { shares: 0, value: 0 }, silver: { shares: 0, value: 0 } },
                netWorth: 100000, currentTimeIndex: 0, isRunning: false, gameInterval: null
            };
            transactionLog.innerHTML = '<p class="text-gray-500">Click \'Start\' or drag the slider to begin your investment journey!</p>';
            startPauseBtn.textContent = 'Start';
            startPauseBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            startPauseBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            initializeChart();
            createAssetControls();
            updateDisplay();
        }

        // --- Event Listeners ---
        startPauseBtn.addEventListener('click', () => {
            if (gameState.isRunning) pauseGame();
            else startGame();
        });

        resetBtn.addEventListener('click', resetGame);
        
        // BUG FIX: The event listener for the time slider is updated to be more robust.
        timeSlider.addEventListener('input', (e) => {
            // When the user interacts with the slider, we must stop the automatic timer.
            if (gameState.isRunning) {
                clearInterval(gameState.gameInterval);
                gameState.isRunning = false;
                startPauseBtn.textContent = 'Resume';
                startPauseBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                startPauseBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            }
            // Now, update the display to the time selected by the user.
            gameState.currentTimeIndex = parseInt(e.target.value, 10);
            updateDisplay();
        });

        // --- Initialization ---
        window.onload = () => {
            initializeChart();
            createAssetControls();
            updateDisplay();
        };
    </script>
</body>
</html>
